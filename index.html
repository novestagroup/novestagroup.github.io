<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Novesta â€“ Easy 5â˜… Review</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --primary:#111827; --ring:#e5e7eb; --accent:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text)}
    .wrap{max-width:720px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{font-size:20px;margin:0}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--ring);padding:6px 10px;border-radius:999px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px;box-shadow:0 8px 30px #0000000d}
    .label{font-weight:600;margin-bottom:8px}
    #review{min-height:110px;line-height:1.6;font-size:16px;background:#f9fafb;border:1px solid var(--ring);border-radius:12px;padding:14px}
    .buttons{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button,a.btn{
      appearance:none;border:1px solid var(--ring);border-radius:12px;padding:14px 16px;font-weight:700;cursor:pointer;
      background:var(--primary);color:#fff;text-decoration:none;text-align:center;flex:1 1 180px
    }
    button.secondary{background:#fff;color:var(--text)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{margin-top:10px;color:var(--muted);font-size:14px}
    .steps{display:grid;grid-template-columns:1fr;gap:8px;margin-top:14px;color:var(--muted);font-size:14px}
    .step{background:#f9fafb;border:1px dashed var(--ring);border-radius:12px;padding:10px}
    .ok{color:#10b981} .warn{color:#d97706} .err{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Novesta â€“ Easy 5â˜… Review</h1>
      <div class="pill"><span id="remaining">â€¦</span> reviews left</div>
    </header>

    <div class="card">
      <div class="label">Your review text</div>
      <div id="review">Tap <b>Generate</b> to get a fresh review.</div>

      <div class="buttons">
        <button id="genBtn">Generate</button>
        <button id="copyBtn" class="secondary" disabled>Copy & Open Google Reviews</button>
      </div>

      <div class="hint" id="hint"></div>

      <div class="steps">
        <div class="step"><b>1.</b> Press <b>Generate</b> â†’ youâ€™ll get a new unused review.</div>
        <div class="step"><b>2.</b> Press <b>Copy & Open Google Reviews</b> â†’ text is copied & reserved.</div>
        <div class="step"><b>3.</b> Paste on the Google page and submit your 5â˜… review.</div>
      </div>
    </div>
  </div>

  <script>
    // ðŸ”— Your Apps Script Web App URL
    const API = "https://script.google.com/macros/s/AKfycby0o_oETDhpXCcicTv-BArsz-9ghW5YBUp5pXIFDFyhkyTh9iMDcyivRXKi1i5B9FCPog/exec";
    // ðŸ”— Where to paste
    const REVIEW_URL = "https://g.page/r/CQo8pe9HyhYeEBM/review";

    const reviewEl  = document.getElementById('review');
    const genBtn    = document.getElementById('genBtn');
    const copyBtn   = document.getElementById('copyBtn');
    const hint      = document.getElementById('hint');
    const remaining = document.getElementById('remaining');

    let current = { id:null, text:"" };

    async function getRemaining(){
      try{
        const r = await fetch(API + "?action=count", {cache:"no-store"});
        const d = await r.json();
        remaining.textContent = d.ok ? d.remaining : "â€¦";
      }catch{ remaining.textContent = "â€¦"; }
    }

    async function generate(){
      hint.textContent = "";
      copyBtn.disabled = true;
      reviewEl.textContent = "Finding a fresh reviewâ€¦";
      try{
        const r = await fetch(API + "?action=next", {cache:"no-store"});
        const d = await r.json();
        if(d.ok && !d.empty){
          current.id = d.id; current.text = d.review;
          reviewEl.textContent = d.review;
          copyBtn.disabled = false;
          await getRemaining();
        }else{
          reviewEl.textContent = "No reviews left. Please contact admin.";
        }
      }catch{
        reviewEl.textContent = "Could not load a review. Try again.";
      }
    }

    async function copyAndReserve(){
      if(!current.id || !current.text) return;
      // Copy
      try{
        await navigator.clipboard.writeText(current.text);
      }catch{
        const ta = document.createElement('textarea');
        ta.value = current.text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      hint.innerHTML = "<span class='ok'>Copied.</span> Reserving for youâ€¦";

      // Reserve
      try{
        const form = new FormData(); form.append('id', String(current.id));
        const r = await fetch(API, {method:"POST", body:form});
        const d = await r.json();
        if(d.ok){
          hint.innerHTML = "<span class='ok'>Reserved.</span> Opening Google Reviewsâ€¦";
          copyBtn.disabled = true;
          current = { id:null, text:"" };
          await getRemaining();
          window.open(REVIEW_URL, "_blank", "noopener");
        }else{
          hint.innerHTML = "<span class='warn'>Someone just used this one.</span> Please press Generate again.";
        }
      }catch{
        hint.innerHTML = "<span class='err'>Could not reserve. Try Generate again.</span>";
      }
    }

    genBtn.addEventListener('click', generate);
    copyBtn.addEventListener('click', copyAndReserve);
    getRemaining();
  </script>
</body>
</html>
